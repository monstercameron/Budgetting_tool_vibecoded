(function(){"use strict";function L(i,c,l,n){return[{kind:i,message:c,recoverable:l,details:n},null]}function _(i){const c=["income","expenses","assets","debts","credit","loans","goals"];for(const m of c)if(!Array.isArray(i[m])){const[r,h]=L("VALIDATION",`${m} must be an array`,!0,{requiredCollectionName:m});return h?[null,h]:[null,r]}const l=(m,r)=>m.reduce((h,A)=>{const x=A[r];return h+(typeof x=="number"?x:0)},0),n=l(i.income,"amount"),v=l(i.expenses,"amount"),P=l(i.assets,"amount"),d=Array.isArray(i.assetHoldings)?i.assetHoldings.reduce((m,r)=>{const h=typeof r.assetMarketValue=="number"?r.assetMarketValue:0,A=typeof r.assetValueOwed=="number"?r.assetValueOwed:0;return m+(h-A)},0):0,u=[...i.debts,...i.loans].reduce((m,r)=>{const h=typeof r.collateralAssetMarketValue=="number"?r.collateralAssetMarketValue:0;return m+(h>0?h:0)},0),b=P+d+u,B=l(i.debts,"amount"),T=l(i.credit,"amount"),F=l(i.loans,"amount"),D=B+T+F,k=n-v,C=b-D,g=n>0?n:1,p=v>0?v:1,O=b>0?b:1,f=i.credit.length===0?0:i.credit.reduce((m,r)=>{const h=typeof r.amount=="number"?r.amount:0,A=typeof r.creditLimit=="number"&&r.creditLimit>0?r.creditLimit:1;return m+h/A},0)/i.credit.length,M=l(i.goals,"targetAmount"),E=l(i.goals,"currentAmount"),$=M>0?E/M*100:0;return[{netWorth:C,netWorthChangeMonthToDate:k,totalAssets:b,totalLiabilities:D,debtToAssetRatio:D/O,debtToIncomeRatio:D/g,savingsRatePercent:k/g*100,expenseRatioPercent:v/g*100,needsVersusWantsSplitPercent:50,cashRunwayMonths:b/p,emergencyFundCoverageMonths:b/p,monthlySurplusDeficit:k,burnRate:v,incomeStabilityVariance:0,creditUtilizationPercent:f*100,averageAprDebtWeighted:0,minimumPaymentBurdenPercentOfIncome:0,loanPayoffEtaMonthsWeighted:0,onTimePaymentStreakMonths:0,goalProgressScorePercent:$},null]}function I(i){if(!i||typeof i!="object"){const[d,u]=L("VALIDATION","currentCollectionsState must be an object",!0);return u?[null,u]:[null,d]}if(!Array.isArray(i.income)||!Array.isArray(i.expenses)){const[d,u]=L("VALIDATION","income and expenses collections must be arrays",!0);return u?[null,u]:[null,d]}const c=i.income.reduce((d,u)=>{const b=typeof u.amount=="number"?u.amount:0;return d+b},0),l=i.expenses.reduce((d,u)=>{const b=typeof u.amount=="number"?u.amount:0;return d+b},0),n=c-l,v=c>0?c:1,P=n/v*100;return[{totalIncome:c,totalExpenses:l,monthlySurplusDeficit:n,savingsRatePercent:P},null]}function ee(i){const[c,l]=_(i);if(l)return[null,l];if(!c){const[e,t]=L("VALIDATION","health metrics are unexpectedly empty",!0);return t?[null,t]:[null,e]}const[n,v]=I(i);if(v)return[null,v];if(!n){const[e,t]=L("VALIDATION","monthly summary is unexpectedly empty",!0);return t?[null,t]:[null,e]}const P=Array.isArray(i.creditCards)?i.creditCards:[],d=P.reduce((e,t)=>e+(typeof t.maxCapacity=="number"?t.maxCapacity:0),0),u=P.reduce((e,t)=>e+(typeof t.currentBalance=="number"?t.currentBalance:0),0),b=i.credit.reduce((e,t)=>e+(typeof t.creditLimit=="number"?t.creditLimit:0),0),B=i.credit.reduce((e,t)=>e+(typeof t.amount=="number"?t.amount:0),0),T=P.length>0?P:i.credit,F=d>0?d:b,D=d>0?u:B,k=i.debts.reduce((e,t)=>e+(typeof t.amount=="number"?t.amount:0),0),C=i.loans.reduce((e,t)=>e+(typeof t.amount=="number"?t.amount:0),0),g=k+D+C,p=i.debts.reduce((e,t)=>e+(typeof t.minimumPayment=="number"?t.minimumPayment:0),0)+T.reduce((e,t)=>e+(typeof t.minimumPayment=="number"?t.minimumPayment:typeof t.monthlyPayment=="number"?t.monthlyPayment:0),0)+i.loans.reduce((e,t)=>e+(typeof t.minimumPayment=="number"?t.minimumPayment:0),0),O=F>0?D/F*100:0,f=n.totalIncome>0?p/n.totalIncome*100:0;let M=0;const E=p>0?n.totalIncome/p:999,$=g>0?c.totalAssets/g:0,N=n.totalIncome>0?Math.abs(n.monthlySurplusDeficit)/n.totalIncome*100:0,m=[...i.debts,...i.loans].filter(e=>(typeof e.collateralAssetMarketValue=="number"?e.collateralAssetMarketValue:0)>0),r=m.reduce((e,t)=>e+(typeof t.amount=="number"?t.amount:0),0),h=m.reduce((e,t)=>e+(typeof t.collateralAssetMarketValue=="number"?t.collateralAssetMarketValue:0),0),A=h>0?r/h*100:0,x=n.totalIncome>0?n.totalIncome:1,U=g>0?g:1,te=i.assets.reduce((e,t)=>{const a=typeof t.recordType=="string"?t.recordType==="savings":!1,s=typeof t.amount=="number"?t.amount:0;return a?e+s:e},0),ie=(Array.isArray(i.assetHoldings)?i.assetHoldings:[]).reduce((e,t)=>{const a=typeof t.item=="string"?t.item.toLowerCase():"",s=a.includes("bank")||a.includes("checking")||a.includes("cash")||a.includes("savings"),o=typeof t.assetMarketValue=="number"?t.assetMarketValue:0,y=typeof t.assetValueOwed=="number"?t.assetValueOwed:0,V=o-y;return s?e+Math.max(0,V):e},0),q=te+ie;M=n.totalExpenses>0?q/n.totalExpenses:0;const S=n.totalExpenses+p,W=S>0?q/S:0,ae=n.totalExpenses>0?q/n.totalExpenses:0,j=n.totalIncome-S,R=n.totalIncome-n.totalExpenses-p,H=R,se=n.totalExpenses>0?p/n.totalExpenses*100:0,ne=[...i.debts,...T,...i.loans].reduce((a,s)=>{const o=typeof s.minimumPayment=="number"?s.minimumPayment:0,y=typeof s.monthlyPayment=="number"?s.monthlyPayment:0;return Math.max(a,Math.max(o,y))},0)/x*100,oe=new Set(["housing","utilities","insurance","internet","phone","hoa"]),re=(i.expenses.reduce((e,t)=>{const a=typeof t.category=="string"?t.category.toLowerCase():"",s=typeof t.amount=="number"?t.amount:0;return oe.has(a)?e+s:e},0)+p)/x*100,G=(()=>{const e=new Map;for(const a of i.income){const s=typeof a.item=="string"&&a.item.trim().length>0?a.item.trim():"Income",o=typeof a.amount=="number"?a.amount:0;e.set(s,(e.get(s)??0)+o)}const t=[...e.values()].reduce((a,s)=>Math.max(a,s),0);return x>0?t/x*100:0})(),K=(()=>{const e=Date.now(),t=45;return[...i.debts,...T,...i.loans].reduce((s,o)=>{const y=typeof o.updatedAt=="string"?o.updatedAt:typeof o.date=="string"?o.date:"";if(!y)return s+1;const V=new Date(y).getTime();return Number.isFinite(V)?(e-V)/(1e3*60*60*24)>t?s+1:s:s+1},0)})(),le=[...i.debts,...T,...i.loans].reduce((t,a)=>{const s=typeof a.amount=="number"?a.amount:typeof a.currentBalance=="number"?a.currentBalance:null,o=typeof s=="number"&&s>=0,y=typeof a.minimumPayment=="number"&&a.minimumPayment>=0,V=typeof a.interestRatePercent=="number"&&a.interestRatePercent>=0;return o&&y&&V?t:t+1},0),ue=(()=>{const e=d,t=b;if(e<=0||t<=0)return 0;const a=e>0?u/e*100:0,s=t>0?B/t*100:0;return Math.abs(a-s)})(),J=T.reduce((e,t)=>{const a=typeof t.interestRatePercent=="number"?t.interestRatePercent:0;return(typeof t.amount=="number"?t.amount:typeof t.currentBalance=="number"?t.currentBalance:0)<=1e3?e:Math.max(e,a)},0),Q=m.reduce((e,t)=>{const a=typeof t.amount=="number"?t.amount:0,s=typeof t.collateralAssetMarketValue=="number"?t.collateralAssetMarketValue:0;if(s<=0)return e;const o=a/s*100,Z=(typeof t.item=="string"?t.item.toLowerCase():"").includes("mortgage")?90:100;return o>Z?e+1:e},0),X=[];function w(e,t,a,s,o){X.push({id:e,severity:t,title:a,detail:s,metricValue:o})}const ce=[{id:"dti-gt-20",severity:"low",title:"Debt-to-income is above 20%",detail:"Debt payments are above conservative comfort range.",value:f,threshold:20},{id:"dti-gt-30",severity:"medium",title:"Debt-to-income is above 30%",detail:"Debt payments are approaching stressed affordability.",value:f,threshold:30},{id:"dti-gt-36",severity:"high",title:"Debt-to-income is above 36%",detail:"Debt payments exceed a common underwriting ceiling.",value:f,threshold:36},{id:"dti-gt-43",severity:"high",title:"Debt-to-income is above 43%",detail:"Debt payments indicate high leverage risk.",value:f,threshold:43},{id:"dti-gt-50",severity:"high",title:"Debt-to-income is above 50%",detail:"Debt payments indicate severe affordability risk.",value:f,threshold:50},{id:"util-total-gt-30",severity:"high",title:"Total credit utilization is above 30%",detail:`Portfolio utilization is ${O.toFixed(2)}% against a 30% threshold.`,value:O,threshold:30},{id:"savings-lt-20",severity:"low",title:"Savings rate is below 20%",detail:"Savings rate is below strong accumulation pace.",value:n.savingsRatePercent,threshold:20,lessThan:!0},{id:"savings-lt-10",severity:"medium",title:"Savings rate is below 10%",detail:"Savings rate may be insufficient for resilience goals.",value:n.savingsRatePercent,threshold:10,lessThan:!0},{id:"savings-lt-0",severity:"high",title:"Savings rate is negative",detail:"Expenses currently exceed income.",value:n.savingsRatePercent,threshold:0,lessThan:!0},{id:"efund-lt-6",severity:"low",title:"Emergency fund below 6 months",detail:"Coverage is below the ideal resilience target.",value:M,threshold:6,lessThan:!0},{id:"efund-lt-3",severity:"medium",title:"Emergency fund below 3 months",detail:"Coverage is below baseline safety target.",value:M,threshold:3,lessThan:!0},{id:"efund-lt-1",severity:"high",title:"Emergency fund below 1 month",detail:"Coverage is critically low for disruptions.",value:M,threshold:1,lessThan:!0},{id:"runway-debt-lt-3",severity:"high",title:"Cash runway including debt is below 3 months",detail:"Liquid savings coverage against expenses plus debt minimums is low.",value:W,threshold:3,lessThan:!0},{id:"runway-debt-lt-1",severity:"high",title:"Cash runway including debt is below 1 month",detail:"Any disruption can force borrowing or missed obligations.",value:W,threshold:1,lessThan:!0},{id:"runway-expense-lt-1",severity:"high",title:"Liquid cash runway is below 1 month of expenses",detail:"Cash-equivalent holdings cover less than one month of expenses.",value:ae,threshold:1,lessThan:!0},{id:"cash-equivalents-lt-1000",severity:"high",title:"Cash equivalents are below $1,000",detail:"Low immediate liquidity increases disruption risk.",value:q,threshold:1e3,lessThan:!0},{id:"dsc-lt-2",severity:"low",title:"Debt service coverage below 2.0",detail:"Income buffer over debt minimums is thinning.",value:E,threshold:2,lessThan:!0},{id:"dsc-lt-1.5",severity:"medium",title:"Debt service coverage below 1.5",detail:"Debt minimums absorb substantial income.",value:E,threshold:1.5,lessThan:!0},{id:"dsc-lt-1.2",severity:"high",title:"Debt service coverage below 1.2",detail:"Income has little room over mandatory debt payments.",value:E,threshold:1.2,lessThan:!0},{id:"liq-lt-1",severity:"medium",title:"Liquidity ratio below 1.0",detail:"Assets are below total liabilities.",value:$,threshold:1,lessThan:!0},{id:"liq-lt-0.5",severity:"high",title:"Liquidity ratio below 0.5",detail:"Assets cover less than half of liabilities.",value:$,threshold:.5,lessThan:!0},{id:"expense-ratio-gt-80",severity:"medium",title:"Expense ratio above 80%",detail:"Most income is consumed by expenses before debt.",value:n.totalExpenses/x*100,threshold:80},{id:"expense-ratio-gt-100",severity:"high",title:"Expense ratio above 100%",detail:"Expenses exceed income before debt obligations.",value:n.totalExpenses/x*100,threshold:100},{id:"liability-ratio-gt-2x-income",severity:"medium",title:"Liabilities exceed 2x yearly income",detail:"Leverage relative to income is elevated.",value:g/(n.totalIncome*12||1),threshold:2},{id:"liability-ratio-gt-3x-income",severity:"high",title:"Liabilities exceed 3x yearly income",detail:"Leverage relative to income is high risk.",value:g/(n.totalIncome*12||1),threshold:3},{id:"liability-ratio-gt-4x-income",severity:"high",title:"Liabilities exceed 4x yearly income",detail:"Leverage relative to income is severe.",value:g/(n.totalIncome*12||1),threshold:4},{id:"payment-burden-gt-15",severity:"low",title:"Debt payment burden above 15%",detail:"Mandatory debt payments reduce flexibility.",value:f,threshold:15},{id:"payment-burden-gt-25",severity:"medium",title:"Debt payment burden above 25%",detail:"Debt payments materially compress monthly cash flow.",value:f,threshold:25},{id:"payment-burden-gt-40",severity:"high",title:"Debt payment burden above 40%",detail:"Debt payments are in stressed range.",value:f,threshold:40},{id:"debt-minimums-vs-expenses-gt-100",severity:"high",title:"Debt minimums exceed monthly expenses",detail:"Debt minimum payments are larger than monthly expenses.",value:se,threshold:100},{id:"single-payment-concentration-gt-25",severity:"medium",title:"A single debt payment exceeds 25% of income",detail:"One recurring payment is highly concentrated against income.",value:ne,threshold:25},{id:"fixed-cost-ratio-gt-60",severity:"high",title:"Fixed-cost ratio is above 60%",detail:"High fixed obligations reduce flexibility during shocks.",value:re,threshold:60},{id:"income-concentration-gt-80",severity:"medium",title:"Income is concentrated above 80% in one source",detail:"A single source dominates total income.",value:G,threshold:80},{id:"income-concentration-gt-90",severity:"high",title:"Income is highly concentrated in one source",detail:"A single-source income disruption would materially impact the plan.",value:G,threshold:90},{id:"secured-ltv-gt-80",severity:"medium",title:"Secured debt LTV is above 80%",detail:"Collateral cushion is thinning on secured balances.",value:A,threshold:80},{id:"secured-ltv-gt-100",severity:"high",title:"Secured debt LTV is above 100%",detail:"Secured balances exceed tracked collateral market value.",value:A,threshold:100},{id:"income-volatility-gt-20",severity:"low",title:"Cash-flow swing proxy above 20%",detail:"Surplus/deficit swing indicates unstable cash profile.",value:N,threshold:20},{id:"income-volatility-gt-40",severity:"medium",title:"Cash-flow swing proxy above 40%",detail:"Cash profile variability may disrupt planning.",value:N,threshold:40},{id:"income-volatility-gt-60",severity:"high",title:"Cash-profile variability is severe",detail:"Cash profile variability is severe.",value:N,threshold:60},{id:"util-mismatch-gt-5",severity:"high",title:"Utilization mismatch across sections",detail:"Credit utilization inputs disagree between credit and card sources.",value:ue,threshold:5},{id:"stale-balance-gt-0",severity:"medium",title:"Some liability balances are stale",detail:"At least one liability balance is older than 45 days or missing timestamps.",value:K,threshold:0},{id:"stale-balance-gt-3",severity:"high",title:"Multiple liability balances are stale",detail:"Several liabilities are stale; forecast confidence is low.",value:K,threshold:3},{id:"forecast-fields-missing-gt-0",severity:"medium",title:"Missing debt fields for forecasting",detail:"One or more liabilities are missing amount, minimum payment, or APR.",value:le,threshold:0}].filter(e=>e.lessThan?e.value<e.threshold:e.value>e.threshold),z=new Map;for(const e of ce){const t=e.id.replace(/-(gt|lt)-.*/,""),a=z.get(t);if(!a){z.set(t,e);continue}(e.lessThan?e.threshold<a.threshold:e.threshold>a.threshold)&&z.set(t,e)}for(const e of z.values())w(e.id,e.severity,e.title,e.detail,e.value);const me=[...P.map((e,t)=>{const a=typeof e.item=="string"?e.item:`Credit ${t+1}`,s=typeof e.currentBalance=="number"?e.currentBalance:0,o=typeof e.maxCapacity=="number"?e.maxCapacity:0,y=o>0?s/o*100:0;return{id:`credit-util-item-${t}`,severity:y>80?"high":"medium",title:`${a} card utilization is elevated`,detail:`${a} utilization is ${y.toFixed(2)}%.`,value:y,threshold:y>80?80:50}}),...i.debts.map((e,t)=>{const a=typeof e.item=="string"?e.item:`Debt ${t+1}`,o=(typeof e.amount=="number"?e.amount:0)/U*100;return{id:`debt-concentration-${t}`,severity:o>60?"high":o>35?"medium":"low",title:`${a} concentration is high`,detail:`${a} is a concentrated share of liabilities.`,value:o,threshold:35}}),...i.loans.map((e,t)=>{const a=typeof e.item=="string"?e.item:`Loan ${t+1}`,o=(typeof e.minimumPayment=="number"?e.minimumPayment:0)/x*100;return{id:`loan-payment-share-${t}`,severity:o>20?"high":o>10?"medium":"low",title:`${a} payment share is high`,detail:`${a} minimum payment is elevated relative to income.`,value:o,threshold:10}})];for(const e of me)e.value>e.threshold&&w(e.id,e.severity,e.title,e.detail,e.value);j<0&&w("negative-operating-cashflow","high","Negative operating cash flow","Monthly income is below expenses plus debt minimums.",j),R<0?w("discretionary-buffer-lt-0","high","Discretionary buffer is negative","There is no discretionary capacity after expenses and debt minimums.",R):R<500&&w("discretionary-buffer-lt-500","medium","Discretionary buffer is below $500","Small surprise expenses can still destabilize the month.",R),J>25&&w("apr-exposure-gt-25","high","High APR exposure on revolving debt","At least one revolving balance above $1,000 has APR above 25%.",J),Q>0&&w("secured-specific-ltv-risk","high","One or more secured debts are near/above risk LTV thresholds","Mortgage above 90% LTV or non-mortgage secured debt above 100% LTV detected.",Q),H<0&&w("forecast-month-end-cash-lt-0","high","Projected month-end cash is negative","Projected month-end cashflow falls below zero with current obligations.",H);const Y=i.income.reduce((e,t)=>{const a=typeof t.amount=="number"?t.amount:0;return(typeof t.item=="string"?t.item.trim():"")&&a===0?e+1:e},0);return Y>0&&w("income-placeholders-gt-0","medium","One or more income sources are unrealized ($0)","Income assumptions include one or more $0 rows that may not be active.",Y),i.goals.reduce((e,t)=>(typeof t.status=="string"?t.status.toLowerCase():"")==="in progress"?e+1:e,0)===0&&w("no-active-goals","medium","No active goals in progress","Without active goals, budget-to-action alignment is likely weak.",0),[[...X].sort((e,t)=>{const a={high:3,medium:2,low:1},s=a[e.severity],o=a[t.severity];return s!==o?o-s:e.metricValue===t.metricValue?e.id.localeCompare(t.id):Math.abs(t.metricValue)-Math.abs(e.metricValue)}).slice(0,50),null]}globalThis.onmessage=i=>{const c=i.data;if(!c||typeof c!="object"){globalThis.postMessage({findings:[],error:{kind:"VALIDATION",message:"worker payload must be an object"}});return}const[l,n]=ee(c.currentCollectionsState);if(n){globalThis.postMessage({findings:[],error:n});return}globalThis.postMessage({findings:l??[],error:null})}})();
