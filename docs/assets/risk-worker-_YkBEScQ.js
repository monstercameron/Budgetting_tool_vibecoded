(function(){"use strict";function E(a,c,l,n){return[{kind:a,message:c,recoverable:l,details:n},null]}function Z(a){const c=["income","expenses","assets","debts","credit","loans","goals"];for(const h of c)if(!Array.isArray(a[h])){const[u,b]=E("VALIDATION",`${h} must be an array`,!0,{requiredCollectionName:h});return b?[null,b]:[null,u]}const l=(h,u)=>h.reduce((b,V)=>{const B=V[u];return b+(typeof B=="number"?B:0)},0),n=l(a.income,"amount"),g=l(a.expenses,"amount"),f=l(a.assets,"amount"),m=[...a.debts,...a.loans].reduce((h,u)=>{const b=typeof u.collateralAssetMarketValue=="number"?u.collateralAssetMarketValue:0;return h+(b>0?b:0)},0),r=f+m,w=l(a.debts,"amount"),$=l(a.credit,"amount"),A=l(a.loans,"amount"),T=w+$+A,M=n-g,N=r-T,k=n>0?n:1,v=g>0?g:1,x=r>0?r:1,C=a.credit.length===0?0:a.credit.reduce((h,u)=>{const b=typeof u.amount=="number"?u.amount:0,V=typeof u.creditLimit=="number"&&u.creditLimit>0?u.creditLimit:1;return h+b/V},0)/a.credit.length,y=l(a.goals,"targetAmount"),L=l(a.goals,"currentAmount"),R=y>0?L/y*100:0;return[{netWorth:N,netWorthChangeMonthToDate:M,totalAssets:r,totalLiabilities:T,debtToAssetRatio:T/x,debtToIncomeRatio:T/k,savingsRatePercent:M/k*100,expenseRatioPercent:g/k*100,needsVersusWantsSplitPercent:50,cashRunwayMonths:r/v,emergencyFundCoverageMonths:r/v,monthlySurplusDeficit:M,burnRate:g,incomeStabilityVariance:0,creditUtilizationPercent:C*100,averageAprDebtWeighted:0,minimumPaymentBurdenPercentOfIncome:0,loanPayoffEtaMonthsWeighted:0,onTimePaymentStreakMonths:0,goalProgressScorePercent:R},null]}function _(a){if(!a||typeof a!="object"){const[m,r]=E("VALIDATION","currentCollectionsState must be an object",!0);return r?[null,r]:[null,m]}if(!Array.isArray(a.income)||!Array.isArray(a.expenses)){const[m,r]=E("VALIDATION","income and expenses collections must be arrays",!0);return r?[null,r]:[null,m]}const c=a.income.reduce((m,r)=>{const w=typeof r.amount=="number"?r.amount:0;return m+w},0),l=a.expenses.reduce((m,r)=>{const w=typeof r.amount=="number"?r.amount:0;return m+w},0),n=c-l,g=c>0?c:1,f=n/g*100;return[{totalIncome:c,totalExpenses:l,monthlySurplusDeficit:n,savingsRatePercent:f},null]}function I(a){const[c,l]=Z(a);if(l)return[null,l];if(!c){const[e,t]=E("VALIDATION","health metrics are unexpectedly empty",!0);return t?[null,t]:[null,e]}const[n,g]=_(a);if(g)return[null,g];if(!n){const[e,t]=E("VALIDATION","monthly summary is unexpectedly empty",!0);return t?[null,t]:[null,e]}const f=Array.isArray(a.creditCards)?a.creditCards:[],m=f.reduce((e,t)=>e+(typeof t.maxCapacity=="number"?t.maxCapacity:0),0),r=f.reduce((e,t)=>e+(typeof t.currentBalance=="number"?t.currentBalance:0),0),w=a.credit.reduce((e,t)=>e+(typeof t.creditLimit=="number"?t.creditLimit:0),0),$=a.credit.reduce((e,t)=>e+(typeof t.amount=="number"?t.amount:0),0),A=f.length>0?f:a.credit,T=m>0?m:w,M=m>0?r:$,N=a.debts.reduce((e,t)=>e+(typeof t.amount=="number"?t.amount:0),0),k=a.loans.reduce((e,t)=>e+(typeof t.amount=="number"?t.amount:0),0),v=N+M+k,x=a.debts.reduce((e,t)=>e+(typeof t.minimumPayment=="number"?t.minimumPayment:0),0)+A.reduce((e,t)=>e+(typeof t.minimumPayment=="number"?t.minimumPayment:typeof t.monthlyPayment=="number"?t.monthlyPayment:0),0)+a.loans.reduce((e,t)=>e+(typeof t.minimumPayment=="number"?t.minimumPayment:0),0),C=T>0?M/T*100:0,y=n.totalIncome>0?x/n.totalIncome*100:0;let L=0;const R=x>0?n.totalIncome/x:999,z=v>0?c.totalAssets/v:0,h=n.totalIncome>0?Math.abs(n.monthlySurplusDeficit)/n.totalIncome*100:0,u=[...a.debts,...a.loans].filter(e=>(typeof e.collateralAssetMarketValue=="number"?e.collateralAssetMarketValue:0)>0),b=u.reduce((e,t)=>e+(typeof t.amount=="number"?t.amount:0),0),V=u.reduce((e,t)=>e+(typeof t.collateralAssetMarketValue=="number"?t.collateralAssetMarketValue:0),0),B=V>0?b/V*100:0,P=n.totalIncome>0?n.totalIncome:1,ee=v>0?v:1,te=a.assets.reduce((e,t)=>{const i=typeof t.recordType=="string"?t.recordType==="savings":!1,s=typeof t.amount=="number"?t.amount:0;return i?e+s:e},0),ie=(Array.isArray(a.assetHoldings)?a.assetHoldings:[]).reduce((e,t)=>{const i=typeof t.item=="string"?t.item.toLowerCase():"",s=i.includes("bank")||i.includes("checking")||i.includes("cash")||i.includes("savings"),o=typeof t.assetMarketValue=="number"?t.assetMarketValue:0,d=typeof t.assetValueOwed=="number"?t.assetValueOwed:0,D=o-d;return s?e+Math.max(0,D):e},0),O=te+ie;L=n.totalExpenses>0?O/n.totalExpenses:0;const S=n.totalExpenses+x,U=S>0?O/S:0,ae=n.totalExpenses>0?O/n.totalExpenses:0,W=n.totalIncome-S,F=n.totalIncome-n.totalExpenses-x,j=F,se=n.totalExpenses>0?x/n.totalExpenses*100:0,ne=[...a.debts,...A,...a.loans].reduce((i,s)=>{const o=typeof s.minimumPayment=="number"?s.minimumPayment:0,d=typeof s.monthlyPayment=="number"?s.monthlyPayment:0;return Math.max(i,Math.max(o,d))},0)/P*100,oe=new Set(["housing","utilities","insurance","internet","phone","hoa"]),re=(a.expenses.reduce((e,t)=>{const i=typeof t.category=="string"?t.category.toLowerCase():"",s=typeof t.amount=="number"?t.amount:0;return oe.has(i)?e+s:e},0)+x)/P*100,H=(()=>{const e=new Map;for(const i of a.income){const s=typeof i.item=="string"&&i.item.trim().length>0?i.item.trim():"Income",o=typeof i.amount=="number"?i.amount:0;e.set(s,(e.get(s)??0)+o)}const t=[...e.values()].reduce((i,s)=>Math.max(i,s),0);return P>0?t/P*100:0})(),G=(()=>{const e=Date.now(),t=45;return[...a.debts,...A,...a.loans].reduce((s,o)=>{const d=typeof o.updatedAt=="string"?o.updatedAt:typeof o.date=="string"?o.date:"";if(!d)return s+1;const D=new Date(d).getTime();return Number.isFinite(D)?(e-D)/(1e3*60*60*24)>t?s+1:s:s+1},0)})(),le=[...a.debts,...A,...a.loans].reduce((t,i)=>{const s=typeof i.amount=="number"?i.amount:typeof i.currentBalance=="number"?i.currentBalance:null,o=typeof s=="number"&&s>=0,d=typeof i.minimumPayment=="number"&&i.minimumPayment>=0,D=typeof i.interestRatePercent=="number"&&i.interestRatePercent>=0;return o&&d&&D?t:t+1},0),ue=(()=>{const e=m,t=w;if(e<=0||t<=0)return 0;const i=e>0?r/e*100:0,s=t>0?$/t*100:0;return Math.abs(i-s)})(),K=A.reduce((e,t)=>{const i=typeof t.interestRatePercent=="number"?t.interestRatePercent:0;return(typeof t.amount=="number"?t.amount:typeof t.currentBalance=="number"?t.currentBalance:0)<=1e3?e:Math.max(e,i)},0),J=u.reduce((e,t)=>{const i=typeof t.amount=="number"?t.amount:0,s=typeof t.collateralAssetMarketValue=="number"?t.collateralAssetMarketValue:0;if(s<=0)return e;const o=i/s*100,Y=(typeof t.item=="string"?t.item.toLowerCase():"").includes("mortgage")?90:100;return o>Y?e+1:e},0),Q=[];function p(e,t,i,s,o){Q.push({id:e,severity:t,title:i,detail:s,metricValue:o})}const ce=[{id:"dti-gt-20",severity:"low",title:"Debt-to-income is above 20%",detail:"Debt payments are above conservative comfort range.",value:y,threshold:20},{id:"dti-gt-30",severity:"medium",title:"Debt-to-income is above 30%",detail:"Debt payments are approaching stressed affordability.",value:y,threshold:30},{id:"dti-gt-36",severity:"high",title:"Debt-to-income is above 36%",detail:"Debt payments exceed a common underwriting ceiling.",value:y,threshold:36},{id:"dti-gt-43",severity:"high",title:"Debt-to-income is above 43%",detail:"Debt payments indicate high leverage risk.",value:y,threshold:43},{id:"dti-gt-50",severity:"high",title:"Debt-to-income is above 50%",detail:"Debt payments indicate severe affordability risk.",value:y,threshold:50},{id:"util-total-gt-30",severity:"high",title:"Total credit utilization is above 30%",detail:`Portfolio utilization is ${C.toFixed(2)}% against a 30% threshold.`,value:C,threshold:30},{id:"savings-lt-20",severity:"low",title:"Savings rate is below 20%",detail:"Savings rate is below strong accumulation pace.",value:n.savingsRatePercent,threshold:20,lessThan:!0},{id:"savings-lt-10",severity:"medium",title:"Savings rate is below 10%",detail:"Savings rate may be insufficient for resilience goals.",value:n.savingsRatePercent,threshold:10,lessThan:!0},{id:"savings-lt-0",severity:"high",title:"Savings rate is negative",detail:"Expenses currently exceed income.",value:n.savingsRatePercent,threshold:0,lessThan:!0},{id:"efund-lt-6",severity:"low",title:"Emergency fund below 6 months",detail:"Coverage is below the ideal resilience target.",value:L,threshold:6,lessThan:!0},{id:"efund-lt-3",severity:"medium",title:"Emergency fund below 3 months",detail:"Coverage is below baseline safety target.",value:L,threshold:3,lessThan:!0},{id:"efund-lt-1",severity:"high",title:"Emergency fund below 1 month",detail:"Coverage is critically low for disruptions.",value:L,threshold:1,lessThan:!0},{id:"runway-debt-lt-3",severity:"high",title:"Cash runway including debt is below 3 months",detail:"Liquid savings coverage against expenses plus debt minimums is low.",value:U,threshold:3,lessThan:!0},{id:"runway-debt-lt-1",severity:"high",title:"Cash runway including debt is below 1 month",detail:"Any disruption can force borrowing or missed obligations.",value:U,threshold:1,lessThan:!0},{id:"runway-expense-lt-1",severity:"high",title:"Liquid cash runway is below 1 month of expenses",detail:"Cash-equivalent holdings cover less than one month of expenses.",value:ae,threshold:1,lessThan:!0},{id:"cash-equivalents-lt-1000",severity:"high",title:"Cash equivalents are below $1,000",detail:"Low immediate liquidity increases disruption risk.",value:O,threshold:1e3,lessThan:!0},{id:"dsc-lt-2",severity:"low",title:"Debt service coverage below 2.0",detail:"Income buffer over debt minimums is thinning.",value:R,threshold:2,lessThan:!0},{id:"dsc-lt-1.5",severity:"medium",title:"Debt service coverage below 1.5",detail:"Debt minimums absorb substantial income.",value:R,threshold:1.5,lessThan:!0},{id:"dsc-lt-1.2",severity:"high",title:"Debt service coverage below 1.2",detail:"Income has little room over mandatory debt payments.",value:R,threshold:1.2,lessThan:!0},{id:"liq-lt-1",severity:"medium",title:"Liquidity ratio below 1.0",detail:"Assets are below total liabilities.",value:z,threshold:1,lessThan:!0},{id:"liq-lt-0.5",severity:"high",title:"Liquidity ratio below 0.5",detail:"Assets cover less than half of liabilities.",value:z,threshold:.5,lessThan:!0},{id:"expense-ratio-gt-80",severity:"medium",title:"Expense ratio above 80%",detail:"Most income is consumed by expenses before debt.",value:n.totalExpenses/P*100,threshold:80},{id:"expense-ratio-gt-100",severity:"high",title:"Expense ratio above 100%",detail:"Expenses exceed income before debt obligations.",value:n.totalExpenses/P*100,threshold:100},{id:"liability-ratio-gt-2x-income",severity:"medium",title:"Liabilities exceed 2x yearly income",detail:"Leverage relative to income is elevated.",value:v/(n.totalIncome*12||1),threshold:2},{id:"liability-ratio-gt-3x-income",severity:"high",title:"Liabilities exceed 3x yearly income",detail:"Leverage relative to income is high risk.",value:v/(n.totalIncome*12||1),threshold:3},{id:"liability-ratio-gt-4x-income",severity:"high",title:"Liabilities exceed 4x yearly income",detail:"Leverage relative to income is severe.",value:v/(n.totalIncome*12||1),threshold:4},{id:"payment-burden-gt-15",severity:"low",title:"Debt payment burden above 15%",detail:"Mandatory debt payments reduce flexibility.",value:y,threshold:15},{id:"payment-burden-gt-25",severity:"medium",title:"Debt payment burden above 25%",detail:"Debt payments materially compress monthly cash flow.",value:y,threshold:25},{id:"payment-burden-gt-40",severity:"high",title:"Debt payment burden above 40%",detail:"Debt payments are in stressed range.",value:y,threshold:40},{id:"debt-minimums-vs-expenses-gt-100",severity:"high",title:"Debt minimums exceed monthly expenses",detail:"Debt minimum payments are larger than monthly expenses.",value:se,threshold:100},{id:"single-payment-concentration-gt-25",severity:"medium",title:"A single debt payment exceeds 25% of income",detail:"One recurring payment is highly concentrated against income.",value:ne,threshold:25},{id:"fixed-cost-ratio-gt-60",severity:"high",title:"Fixed-cost ratio is above 60%",detail:"High fixed obligations reduce flexibility during shocks.",value:re,threshold:60},{id:"income-concentration-gt-80",severity:"medium",title:"Income is concentrated above 80% in one source",detail:"A single source dominates total income.",value:H,threshold:80},{id:"income-concentration-gt-90",severity:"high",title:"Income is highly concentrated in one source",detail:"A single-source income disruption would materially impact the plan.",value:H,threshold:90},{id:"secured-ltv-gt-80",severity:"medium",title:"Secured debt LTV is above 80%",detail:"Collateral cushion is thinning on secured balances.",value:B,threshold:80},{id:"secured-ltv-gt-100",severity:"high",title:"Secured debt LTV is above 100%",detail:"Secured balances exceed tracked collateral market value.",value:B,threshold:100},{id:"income-volatility-gt-20",severity:"low",title:"Cash-flow swing proxy above 20%",detail:"Surplus/deficit swing indicates unstable cash profile.",value:h,threshold:20},{id:"income-volatility-gt-40",severity:"medium",title:"Cash-flow swing proxy above 40%",detail:"Cash profile variability may disrupt planning.",value:h,threshold:40},{id:"income-volatility-gt-60",severity:"high",title:"Cash-profile variability is severe",detail:"Cash profile variability is severe.",value:h,threshold:60},{id:"util-mismatch-gt-5",severity:"high",title:"Utilization mismatch across sections",detail:"Credit utilization inputs disagree between credit and card sources.",value:ue,threshold:5},{id:"stale-balance-gt-0",severity:"medium",title:"Some liability balances are stale",detail:"At least one liability balance is older than 45 days or missing timestamps.",value:G,threshold:0},{id:"stale-balance-gt-3",severity:"high",title:"Multiple liability balances are stale",detail:"Several liabilities are stale; forecast confidence is low.",value:G,threshold:3},{id:"forecast-fields-missing-gt-0",severity:"medium",title:"Missing debt fields for forecasting",detail:"One or more liabilities are missing amount, minimum payment, or APR.",value:le,threshold:0}].filter(e=>e.lessThan?e.value<e.threshold:e.value>e.threshold),q=new Map;for(const e of ce){const t=e.id.replace(/-(gt|lt)-.*/,""),i=q.get(t);if(!i){q.set(t,e);continue}(e.lessThan?e.threshold<i.threshold:e.threshold>i.threshold)&&q.set(t,e)}for(const e of q.values())p(e.id,e.severity,e.title,e.detail,e.value);const me=[...f.map((e,t)=>{const i=typeof e.item=="string"?e.item:`Credit ${t+1}`,s=typeof e.currentBalance=="number"?e.currentBalance:0,o=typeof e.maxCapacity=="number"?e.maxCapacity:0,d=o>0?s/o*100:0;return{id:`credit-util-item-${t}`,severity:d>80?"high":"medium",title:`${i} card utilization is elevated`,detail:`${i} utilization is ${d.toFixed(2)}%.`,value:d,threshold:d>80?80:50}}),...a.debts.map((e,t)=>{const i=typeof e.item=="string"?e.item:`Debt ${t+1}`,o=(typeof e.amount=="number"?e.amount:0)/ee*100;return{id:`debt-concentration-${t}`,severity:o>60?"high":o>35?"medium":"low",title:`${i} concentration is high`,detail:`${i} is a concentrated share of liabilities.`,value:o,threshold:35}}),...a.loans.map((e,t)=>{const i=typeof e.item=="string"?e.item:`Loan ${t+1}`,o=(typeof e.minimumPayment=="number"?e.minimumPayment:0)/P*100;return{id:`loan-payment-share-${t}`,severity:o>20?"high":o>10?"medium":"low",title:`${i} payment share is high`,detail:`${i} minimum payment is elevated relative to income.`,value:o,threshold:10}})];for(const e of me)e.value>e.threshold&&p(e.id,e.severity,e.title,e.detail,e.value);W<0&&p("negative-operating-cashflow","high","Negative operating cash flow","Monthly income is below expenses plus debt minimums.",W),F<0?p("discretionary-buffer-lt-0","high","Discretionary buffer is negative","There is no discretionary capacity after expenses and debt minimums.",F):F<500&&p("discretionary-buffer-lt-500","medium","Discretionary buffer is below $500","Small surprise expenses can still destabilize the month.",F),K>25&&p("apr-exposure-gt-25","high","High APR exposure on revolving debt","At least one revolving balance above $1,000 has APR above 25%.",K),J>0&&p("secured-specific-ltv-risk","high","One or more secured debts are near/above risk LTV thresholds","Mortgage above 90% LTV or non-mortgage secured debt above 100% LTV detected.",J),j<0&&p("forecast-month-end-cash-lt-0","high","Projected month-end cash is negative","Projected month-end cashflow falls below zero with current obligations.",j);const X=a.income.reduce((e,t)=>{const i=typeof t.amount=="number"?t.amount:0;return(typeof t.item=="string"?t.item.trim():"")&&i===0?e+1:e},0);return X>0&&p("income-placeholders-gt-0","medium","One or more income sources are unrealized ($0)","Income assumptions include one or more $0 rows that may not be active.",X),a.goals.reduce((e,t)=>(typeof t.status=="string"?t.status.toLowerCase():"")==="in progress"?e+1:e,0)===0&&p("no-active-goals","medium","No active goals in progress","Without active goals, budget-to-action alignment is likely weak.",0),[[...Q].sort((e,t)=>{const i={high:3,medium:2,low:1},s=i[e.severity],o=i[t.severity];return s!==o?o-s:e.metricValue===t.metricValue?e.id.localeCompare(t.id):Math.abs(t.metricValue)-Math.abs(e.metricValue)}).slice(0,50),null]}globalThis.onmessage=a=>{const c=a.data;if(!c||typeof c!="object"){globalThis.postMessage({findings:[],error:{kind:"VALIDATION",message:"worker payload must be an object"}});return}const[l,n]=I(c.currentCollectionsState);if(n){globalThis.postMessage({findings:[],error:n});return}globalThis.postMessage({findings:l??[],error:null})}})();
