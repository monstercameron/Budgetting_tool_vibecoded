# Supabase Setup

## 1) Create project and app
- Create a Supabase project.
- In Project Settings -> API, copy:
  - `Project URL`
  - `anon public key`

## 2) Enable Email auth
- Authentication -> Providers -> Email -> Enable.
- Keep `Confirm email` enabled for magic-link flow.
- Add your app origin(s) to URL configuration:
  - `http://127.0.0.1:4000`
  - production domain later.

## 3) Create required tables
Run in SQL Editor:

```sql
create table if not exists public.profile_current (
  user_id uuid primary key references auth.users(id) on delete cascade,
  profile_payload jsonb not null,
  saved_at_iso text not null,
  updated_at timestamptz not null default now()
);

create table if not exists public.profile_history (
  id bigint generated by default as identity primary key,
  user_id uuid not null references auth.users(id) on delete cascade,
  profile_payload jsonb not null,
  saved_at_iso text not null,
  created_at timestamptz not null default now()
);
```

## 4) Enable RLS and policies

```sql
alter table public.profile_current enable row level security;
alter table public.profile_history enable row level security;

create policy "profile_current_select_own" on public.profile_current
for select using (auth.uid() = user_id);

create policy "profile_current_upsert_own" on public.profile_current
for insert with check (auth.uid() = user_id);

create policy "profile_current_update_own" on public.profile_current
for update using (auth.uid() = user_id) with check (auth.uid() = user_id);

create policy "profile_history_select_own" on public.profile_history
for select using (auth.uid() = user_id);

create policy "profile_history_insert_own" on public.profile_history
for insert with check (auth.uid() = user_id);
```

## 5) In app modal
- Open Export Financial Profile JSON.
- Supabase Sync section:
  - Enable = true
  - Paste URL + anon key
  - Enter auth email
  - Save Supabase Config
  - Send Code
  - Enter OTP code from email
  - Verify Code
  - Push Supabase / Pull Supabase

Notes:
- OTP pending email + request timestamp are cached in localStorage so refresh does not lose sign-in progress.
- Ensure your Supabase email template includes the OTP token variable for code-based verification.
